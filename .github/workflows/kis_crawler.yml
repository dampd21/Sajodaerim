name: KIS Sales Crawler

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: '시작일 (YYYY-MM-DD)'
        required: false
        default: ''
      end_date:
        description: '종료일 (YYYY-MM-DD)'
        required: false
        default: ''
      force:
        description: '강제 재수집'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

  schedule:
    # 매일 오후 11시 (KST) = UTC 14:00
    - cron: '0 14 * * *'

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set date range for scheduled run
        if: github.event_name == 'schedule'
        run: |
          # 2일 전 ~ 오늘 데이터 수집
          echo "START_DATE=$(date -d '2 days ago' '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "END_DATE=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "FORCE=false" >> $GITHUB_ENV

      - name: Set date range for manual run
        if: github.event_name == 'workflow_dispatch'
        run: |
          START="${{ github.event.inputs.start_date }}"
          END="${{ github.event.inputs.end_date }}"
          FORCE="${{ github.event.inputs.force }}"
          
          if [ -z "$START" ]; then
            START=$(date -d '2 days ago' '+%Y-%m-%d')
          fi
          if [ -z "$END" ]; then
            END=$(date '+%Y-%m-%d')
          fi
          
          echo "START_DATE=$START" >> $GITHUB_ENV
          echo "END_DATE=$END" >> $GITHUB_ENV
          echo "FORCE=$FORCE" >> $GITHUB_ENV

      - name: Run KIS crawler
        env:
          KIS_USER_ID: ${{ secrets.KIS_USER_ID }}
          KIS_USER_PWD: ${{ secrets.KIS_USER_PWD }}
        run: |
          echo "=== Starting KIS Crawler ==="
          echo "Start Date: $START_DATE"
          echo "End Date: $END_DATE"
          echo "Force: $FORCE"
          
          FORCE_FLAG=""
          if [ "$FORCE" = "true" ]; then
            FORCE_FLAG="--force"
          fi
          
          python kis_crawler.py --start-date "$START_DATE" --end-date "$END_DATE" $FORCE_FLAG

      - name: Generate sales report
        run: python generate_sales_report.py

      - name: Commit and push data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add output/ docs/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update KIS sales data: $START_DATE ~ $END_DATE"
            git push
          fi
